<app-navbar></app-navbar>

<div class="page-container">
  <div class="page-header">
    <h2>Mes Statistiques</h2>
    <p>Suivez vos progrès et performances</p>
  </div>

  <!-- Loader -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loader"></div>
    <p>Chargement de vos statistiques...</p>
  </div>

  <!-- Message si aucune donnée -->
  <div *ngIf="!isLoading && totalQuizzesCompleted === 0" class="no-data-message">
    <div class="no-data-icon">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
        <circle cx="12" cy="12" r="10" />
        <path d="M12 6v6l4 2" />
      </svg>
    </div>
    <h3>Commencez votre parcours d'apprentissage !</h3>
    <p>Complétez votre premier quiz pour voir apparaître vos statistiques.</p>
    <button class="start-button" routerLink="/quiz-list">
      Voir les quiz disponibles
    </button>
  </div>

  <!-- Statistiques principales -->
  <div *ngIf="!isLoading && totalQuizzesCompleted > 0" class="stats-overview">
    <div class="overview-card">
      <h3>{{ totalQuizzesCompleted }}</h3>
      <p>Quiz complétés</p>
    </div>
    <div class="overview-card">
      <h3>{{ averageScore }}%</h3>
      <p>Score moyen</p>
    </div>
    <div class="overview-card">
      <h3>{{ bestScore }}%</h3>
      <p>Meilleur score</p>
    </div>
    <div class="overview-card">
      <h3>{{ getFormattedTotalTime() }}</h3>
      <p>Temps total</p>
    </div>
  </div>

  <!-- Grille des statistiques détaillées -->
  <div *ngIf="!isLoading && totalQuizzesCompleted > 0" class="stats-grid">

    <!-- Progression Globale -->
    <div class="stat-card">
      <div class="stat-icon">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 3v18h18" />
          <path d="M18 17V9" />
          <path d="M13 17V5" />
          <path d="M8 17v-3" />
        </svg>
      </div>
      <h3>Progression Globale</h3>
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="globalCompletionRate"
            [style.background]="getProgressColor(globalCompletionRate)"></div>
        </div>
        <div class="progress-text">
          <span>{{ globalCompletionRate }}% complété ({{ completionText }})</span>
        </div>
      </div>

      <!-- Progression par thème -->
      <div class="theme-progress" *ngIf="themeStats.length > 0">
        <h4>Par thème :</h4>
        <div class="theme-item" *ngFor="let theme of themeStats">
          <div class="theme-info">
            <span class="theme-name">{{ getThemeDisplayName(theme.theme) }}</span>
            <span class="theme-completion">{{ theme.completionRate }}%</span>
          </div>
          <div class="mini-progress-bar">
            <div class="mini-progress-fill" [style.width.%]="theme.completionRate"
              [style.background]="getProgressColor(theme.completionRate)"></div>
          </div>
        </div>
      </div>

      <!-- Message si aucun thème disponible -->
      <div *ngIf="themeStats.length === 0" class="no-theme-data">
        <p>Aucun thème disponible pour le moment</p>
      </div>
    </div>

    <!-- Quiz par Semaine -->
    <div class="stat-card">
      <div class="stat-icon">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
          <line x1="16" x2="16" y1="2" y2="6" />
          <line x1="8" x2="8" y1="2" y2="6" />
          <line x1="3" x2="21" y1="10" y2="10" />
        </svg>
      </div>
      <h3>Activité Hebdomadaire</h3>
      <div class="chart-container">
        <div class="chart-placeholder" *ngIf="weeklyStats.length > 0">
          <div class="chart-bars">
            <div class="bar-container" *ngFor="let week of weeklyStats">
              <div class="bar" [style.height]="getWeeklyChartHeight(week)"
                [style.background]="getProgressColor(week.averageScore)"></div>
              <span class="bar-label">{{ week.weekLabel}}</span>
              <span class="bar-value">{{ week.quizCount }} quiz</span>
              <span class="bar-score">{{ week.averageScore }}%</span>
            </div>
          </div>
        </div>
        <div *ngIf="weeklyStats.length === 0" class="no-data">
          <p>Aucune activité hebdomadaire pour le moment</p>
          <small>Complétez plus de quiz pour voir votre progression</small>
        </div>
      </div>
    </div>

    <!-- Meilleurs Résultats -->
    <div class="stat-card">
      <div class="stat-icon">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" />
        </svg>
      </div>
      <h3>Meilleurs Résultats</h3>
      <div class="best-results">
        <div class="result-item" *ngFor="let result of bestResults">
          <div class="result-info">
            <span class="subject">{{ result.theme }}</span>
            <span class="quiz-title">{{ result.quizTitle }}</span>
          </div>
          <span class="score" [style.color]="getProgressColor(result.score)">{{ result.score }}%</span>
        </div>
        <div *ngIf="bestResults.length === 0" class="no-results">
          <p>Vos meilleurs résultats apparaîtront ici</p>
          <small>Complétez des quiz de différents thèmes pour voir vos performances</small>
        </div>
      </div>
    </div>

    <!-- Statistiques par Thème -->
    <div class="stat-card theme-stats" *ngIf="themeStats.length > 0">
      <div class="stat-icon">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
          <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
        </svg>
      </div>
      <h3>Performance par Thème</h3>
      <div class="theme-stats-list">
        <div class="theme-stat-item" *ngFor="let theme of themeStats">
          <div class="theme-header">
            <h4>{{ getThemeDisplayName(theme.theme) }}</h4>
            <span class="theme-completion-badge" [style.background]="getProgressColor(theme.averageScore)">
              {{ theme.averageScore }}%
            </span>
          </div>
          <div class="theme-details">
            <div class="detail">
              <span>Quiz complétés :</span>
              <span><strong>{{ theme.quizCount }}</strong>/{{ theme.totalQuizzes }}</span>
            </div>
            <div class="detail" *ngIf="theme.quizCount > 0">
              <span>Meilleur score :</span>
              <span><strong>{{ theme.bestScore }}%</strong></span>
            </div>
            <div class="detail" *ngIf="theme.quizCount > 0">
              <span>Score moyen :</span>
              <span><strong>{{ theme.averageScore }}%</strong></span>
            </div>
            <div class="detail">
              <span>Taux de completion :</span>
              <span><strong>{{ theme.completionRate }}%</strong></span>
            </div>
          </div>
          <div class="theme-progress-bar">
            <div class="theme-progress-fill" [style.width.%]="theme.completionRate"
              [style.background]="getProgressColor(theme.completionRate)"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Historique Récent -->
    <div class="stat-card recent-history" *ngIf="recentResults.length > 0">
      <div class="stat-icon">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" />
          <polyline points="12,6 12,12 16,14" />
        </svg>
      </div>
      <h3>Historique Récent</h3>
      <div class="recent-results">
        <div class="recent-item" *ngFor="let result of recentResults.slice(-5).reverse()">
          <div class="recent-info">
            <h4>{{ result.quizTitle }}</h4>
            <div class="recent-meta">
              <span class="recent-date">{{ result.completedAt | date:'dd/MM/yyyy à HH:mm' }}</span>
              <span class="recent-theme">{{ getThemeDisplayName(result.theme || 'general') }}</span>
            </div>
            <div class="recent-details">
              <span class="correct-answers">{{ result.correctAnswers }}/{{ result.totalQuestions }} correctes</span>
              <span class="time-spent" *ngIf="result.timeSpent > 0">{{ result.timeSpent | number:'1.0-0' }}s</span>
            </div>
          </div>
          <div class="recent-score" [style.color]="getProgressColor(result.percentage)">
            {{ result.percentage }}%
          </div>
        </div>
      </div>
    </div>

    <!-- Statistiques Globales Détaillées -->
    <div class="stat-card global-stats" *ngIf="recentResults.length > 0">
      <div class="stat-icon">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="20" x2="18" y2="10" />
          <line x1="12" y1="20" x2="12" y2="4" />
          <line x1="6" y1="20" x2="6" y2="14" />
        </svg>
      </div>
      <h3>Analyse Globale</h3>
      <div class="global-metrics">
        <div class="metric">
          <div class="metric-value">{{ totalQuizzesAvailable }}</div>
          <div class="metric-label">Quiz disponibles</div>
        </div>
        <div class="metric">
          <div class="metric-value">{{ totalQuizzesCompleted }}</div>
          <div class="metric-label">Quiz complétés</div>
        </div>
        <div class="metric">
          <div class="metric-value">{{ globalCompletionRate }}%</div>
          <div class="metric-label">Taux de completion</div>
        </div>
        <div class="metric">
          <div class="metric-value">{{ getTotalQuestionsAnswered() }}</div>
          <div class="metric-label">Questions répondues</div>
        </div>
      </div>

      <div class="performance-summary">
        <h4>Résumé de Performance</h4>
        <div class="performance-item">
          <span>Précision moyenne :</span>
          <span [style.color]="getProgressColor(averageScore)">{{ averageScore }}%</span>
        </div>
        <div class="performance-item">
          <span>Temps moyen par quiz :</span>
          <span>{{ getAverageTimePerQuiz() }}</span>
        </div>
        <div class="performance-item">
          <span>Quiz par semaine (moyenne) :</span>
          <span>{{ getAverageQuizzesPerWeek() }}</span>
        </div>
      </div>
    </div>

  </div>

  <!-- Message d'encouragement pour continuer -->
  <div *ngIf="!isLoading && totalQuizzesCompleted > 0 && globalCompletionRate < 100" class="encouragement-message">
    <div class="encouragement-content">
      <h4>🎯 Continuez sur votre lancée !</h4>
      <p>Il vous reste {{ totalQuizzesAvailable - totalQuizzesCompleted }} quiz à découvrir.
        Votre progression actuelle est de {{ globalCompletionRate }}%.</p>
      <button class="continue-button" routerLink="/quiz-list">
        Continuer l'apprentissage
      </button>
    </div>
  </div>

  <!-- Message de félicitations si 100% -->
  <div *ngIf="!isLoading && globalCompletionRate >= 100" class="completion-message">
    <div class="completion-content">
      <h4>🏆 Félicitations !</h4>
      <p>Vous avez complété tous les quiz disponibles avec un score moyen de {{ averageScore }}%.</p>
      <p>Continuez à vous perfectionner en refaisant les quiz pour améliorer vos scores !</p>
    </div>
  </div>
</div>